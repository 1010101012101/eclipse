<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Removing restrictions on valid characters in paths</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="Content-Style-Type" content="text/css">
    <link href="http://dev.eclipse.org/default_style.css" rel="stylesheet" type="text/css">
</head>
<body bgcolor="#ffffff">

<table width="100%">
<tr><td style="background:#0080C0"><b><span style="color:white">Proposal</span></b></td></tr>
</table>
 
<h1>Removing restrictions on valid characters in paths</h1>
 
<blockquote> <b>Summary</b>  <br>
The data structure <tt>org.eclipse.core.runtime.IPath</tt> and its 
canonical implementation, <tt>org.eclipse.core.runtime.Path</tt>, impose
restrictions on segment names that can be more restrictive
than those for file names in the underlying file system. When Eclipse paths
are used to represent file system paths, these restrictions prevent 
valid files from being added to the Eclipse workspace. This document
describes the current set of restrictions in Eclipse 3.0, and proposes changes to
lift these restrictions.
<p>
<font size="-1">Last modified: October 1, 2004</font> 
</blockquote>
<p>
<h3>Background</h3>
<p>
<tt>IPath</tt> is an abstract data structure supplied by the <tt>org.eclipse.core.runtime</tt>
plug-in, and consists of the following parts:
<ul>
<li>An optional device (a <tt>String</tt>)</li>
<li>Zero or more ordered segments (represented as <tt>String</tt>)</li>
<li>Optional leading, trailing, and UNC separators</li>
</ul>
<p>
To facilitate conversion between <tt>IPath</tt> and <tt>String</tt>
instances, <tt>IPath</tt> reserves the colon (':') character as the device
delimiter, and the forward and back slash ('/' and '\') characters as segment delimiters.
The API javadoc for <tt>IPath.isValidSegment</tt> outlines the complete set
of restrictions:
 <ul>
 <li> the empty string is not valid
 <li> any string containing the colon character (":") is not valid
 <li> any string containing the slash character ("/") is not valid
 <li> any string containing the backslash character ("\") is not valid
 <li> any string starting or ending with a whitespace character is not valid
 <li> all other strings are valid
 </ul>
Contrast this with the restrictions on file names in Unix (as defined in the "Base Definitions" volume 
of IEEE Std. 1003.1-2001, section 3.169 Filename):
 <ul>
 <li> the empty string is not valid </li>
 <li> any string containing the slash character ('/') is not valid</li>
 <li> the strings "." and ".." have special meaning</li>
 <li> any string containing the null byte is not valid</li>
 <li> all other strings are valid</li>
 </ul>
Thus when Eclipse <tt>IPath</tt> objects are used to represent Unix file names,
they are unable to represent file names containing '\' or ':', or file names with leading
or trailing white space.

<h3>Proposed Solution</h3>
<p>
Lifting the restriction on paths with leading or trailing whitespace and paths
containing the '\' character is easily achieved by specifying a new constructor for 
creation of paths.  Lifting the restriction on the ':' character is more
difficult, since it is needed by the path constructor to delimit the optional device
string. 
<p>
A possible solution is to make the path constructor platform dependent. Thus, the device
separator would only be used on operating systems that specify a device
in file names (i.e., Windows).  The major drawback of this approach is that it breaks existing
clients of <tt>IPath</tt> that want to use paths in a platform-independent way.
This includes not only plug-ins that are using the device portion of paths for other
uses, but also plug-ins that want to treat paths in a platform-neutral way. For example,
a plug-in running on Linux might want to read and manipulate paths that happen 
to represent Windows paths with meaningful devices. Using the host operating
system to make assumptions about data that might not be intended for that platform
will result in unwanted side-effects.
<p>
The proposed solution accomodates the two interesting categories 
of <tt>IPath</tt> users:
<ul>
<li>Code that needs a platform-specific representation. In other words, someone that
actually wants to open a stream on a file, delete a file, etc. They essentially need to
translate between an <tt>IPath</tt> and a <tt>java.io.File</tt>.</li>
<li>Code that is reading, storing, and manipulating file system paths, but does 
not need the platform-specific manifestation. In particular, there is a strong need
for a serialized representation of paths in a platform-neutral way so that they can 
be later read and interpreted on a different platform (typically in the form of a path
that is relative to some platform specific prefix represented by a variable).
</ul>
<tt>IPath</tt> already acknowledges these two uses in its <tt>toString</tt> methods.
The standard <tt>toString</tt> method creates a platform-neutral encoding of
the path as a <tt>String</tt>. The <tt>toOSString</tt> method creates a platform-specific
encoding suitable for passing to <tt>java.io.File</tt> or other API that deals directly
with the file system.
<p>
The proposed solution is to introduce two constructors for creating <tt>IPath</tt>
that perform the inverse of the two existing <tt>toString</tt> methods:
<ul>
<li>A constructor that decodes a platform-specific string.  For example, this would 
parse the output of a previous call to <tt>IPath.toOSString</tt>, or the value returned
by <tt>java.io.File.getAbsolutePath</tt>.</li>
<li>A constructor that decodes a platform-neutral string, such as the output of
a previous call to <tt>IPath.toString</tt>.</li>
</ul>
<p>
Most clients would continue to use the platform-neutral form of paths. The path
can be converted to/from a platform-specific representation when interaction
with the local file system is required. 
<p>
The platform-neutral encoding of paths (conversion from IPath to String) would allow
all characters except slash ('/') in segment names, and include an optional device 
separated from the segments by a double slash. The following are some examples
of windows file system paths and the corresponding platform-neutral encoding:
<ul>
<li>"C:\folder\file.txt" becomes "C:///folder/file.txt"</li>
<li>"C:folder\file.txt" becomes "C://folder/file.txt"</li>
<li>"C:\folder\" becomes "C:///folder/"</li>
</ul>
Canonical Unix paths always look identical to their platform-neutral encoding. The lack
of device is determined by the absence of a leading double-slash:
<ul>
<li>"/etc/" is encoded as "/etc/"</li>
<li>"/etc/passwd" is encoded as "/etc/passwd"</li>
<li>"/etc/timeNowIs4:25:12PM" is encoded as "/etc/timeNowIs4:25:12PM"</li>
<li>"/etc/foo\bar" is encoded as "/etc/foo\bar"</li>
</ul>
<p>
 UNC paths, which typically have no device but have a double leading separator 
 would be encoded with four leading slashes:
<ul>
<li>"//Server/Volume" becomes "////Server/Volume"</li>
</ul>
If for some reason a UNC path had a device, it would preceed the slashes:
<ul>
<li>"C://Server/Volume" becomes "C:////Server/Volume"</li>
</ul>
<p>
This platform-neutral encoding unambiguously encodes all possible paths on
all supported platforms.  In addition, if this platform-neutral encoding is
passed to <tt>java.io.File</tt> on either Unix or Windows, it will be handled
correctly.  The Windows implementation of the <tt>java.io.File</tt> constructor
accepts front slashes as a path separator, and all plaforms collapse and ignore duplicate slashes.
<p>
The platform-specific Path constructor would impose the minimum platform-specific
requirements needed to unambiguosly parse all possible paths on that platform. 
The Windows implementation, for example, will interpret everything up to the
first ':' as the device, and treat both '/' and '\' as path segment separators. No
other rules would be imposed. Thus the existing restriction on paths that prevents
path segments from having leading or trailing whitespace will no longer be enforced
on any platform.
<p>
As before, detailed validation of all legal characters and names on that platform 
will not be enforced. Some clients use technology such as Cygwin or Samba to 
mount foreign file systems on a platform. In these situations, path name rules
for the local file system do not apply. While it is difficult to fully support these users,
any additional platform-specific verification performed on paths causes further
problems for these users. Imposing the absolute minimum requirements for
unamiguously parsing paths allows the majority of users to function without
further impacting the corner cases.
</p>
<h3>API Details</h3>
<p>
The following existing methods on <tt>IPath</tt> and <tt>Path</tt> would be affected:
<ul>
<li>isValidPath. This method is no longer needed. All <tt>String</tt> instances
can now be interpreted as valid paths. In Eclipse 3.0 this method only enforces the
restriction that segments cannot contain ':' and cannot begin or end in whitespace.  
This method will be deprecated Eclipse 3.1, and its implementation left
unchanged.</li>
<li>isValidSegment. Since the only real restriction now is that segments cannot
contain the '/' character, this method is also no longer needed. This method was
previously only useful for clients wanting to call <tt>IPath.append(String)</tt>
without the possibility of error.  This <tt>append</tt> method has always handled
strings containing '/' by appending multiple segments to the receiver's path.
This method will be deprecated Eclipse 3.1, and its implementation left
unchanged.</li>
<li>toString. The implementation of this method will be changed to the new format
that uses the double front slash as the device separator.
<li>Path constructors (<tt>Path(String)</tt> and <tt>Path(String,String)</tt>).
These constructors are the root of the existing problems, since they are designed
to accept both platform-specific paths, and platform-neutral paths produced by
a previous call to <tt>IPath.toString</tt>.
These constructors will be deprecated Eclipse 3.1, and their implementations left
unchanged to avoid unnecessary breakage of existing callers.</li>
</ul>
New methods for Eclipse 3.1:
<ul>
<li><tt>Path.fromString</tt>. A factory method for producing an <tt>IPath</tt>
given a platform-neutral encoding of a string. This is the inverse of the
<tt>IPath.toString</tt> method.</li>
<li><tt>Path.fromOSString</tt>. A factory method for producing an <tt>IPath</tt>
given a platform-specific encoding of a string. This is the inverse of the
<tt>IPath.toOSString</tt> method.</li>
</ul>
</p>
<h3>Impact</h3>
<p>
All callers of the existing <tt>Path</tt> constructors will need to migrate to one
of the two path factory methods, depending on the origin of the path string being
used.  All clients who store absolute <tt>IPath</tt> objects as platform-neutral 
strings in a serialized form (as produced by <tt>IPath.toString</tt> in Eclipse 3.0), 
and require cross-platform interoperability, will need to migrate to the new 
platform-neutral string representation of <tt>IPath</tt> as produced by the 
revised <tt>toString</tt> implementation. Clients not requiring cross-platform
compatibility can use the new <tt>Path.fromOSString</tt> method to parse
previously stored strings. Note that this does not generally happen in practice. 
I.e., absolute paths are almost never compatible across platforms due to the presence
of the Windows device qualifier. Most serialized 
paths that require cross-platform interoperability generally store paths that are 
relative to a variable that expands to a platform-specific prefix.  The encoding of 
relative paths with no device is unchanged from Eclipse 3.0.
</p>
<h3>Bug reference</h3>
<p>
<ul>
<li><a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=24152">bug 24152</a></li>
</ul>
</body>
</html>